
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Management System</title>
    
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 0;
      }
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        flex-direction: column;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .error {
        color: #e74c3c;
        text-align: center;
        padding: 20px;
        max-width: 600px;
        margin: 50px auto;
      }
      .retry-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px;
      }
      .retry-btn:hover {
        background: #2980b9;
      }
    </style>
  </head>
  <body>
    <div id="nc-root">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading CMS...</p>
      </div>
    </div>

    <script>
      console.log('CMS initialization starting...');
      
      // Clear any existing cache to prevent conflicts
      if ('caches' in window) {
        caches.keys().then(function(cacheNames) {
          cacheNames.forEach(function(cacheName) {
            caches.delete(cacheName);
          });
        });
      }

      // Initialize Netlify Identity
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', user => {
          console.log('Identity initialized:', user ? 'with user' : 'without user');
          if (!user) {
            window.netlifyIdentity.on('login', () => {
              console.log('User logged in');
              setTimeout(() => {
                window.location.reload();
              }, 100);
            });
          }
        });
      }

      // Function to show error
      function showError(message) {
        document.getElementById('nc-root').innerHTML = `
          <div class="error">
            <h2>CMS Error</h2>
            <p>${message}</p>
            <button class="retry-btn" onclick="window.location.reload()">Try Again</button>
            <button class="retry-btn" onclick="window.location.href='/'">Return to Site</button>
          </div>
        `;
      }

      // Load CMS with proper error handling
      function loadCMS() {
        console.log('Loading CMS script...');
        
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
        script.type = 'text/javascript';
        
        script.onload = function() {
          console.log('CMS script loaded successfully');
          
          // Wait a moment then initialize
          setTimeout(() => {
            try {
              if (window.CMS) {
                console.log('CMS object available, initializing...');
                window.CMS.init({
                  config: {
                    backend: {
                      name: 'git-gateway',
                      branch: 'main'
                    },
                    media_folder: 'public/uploads',
                    public_folder: '/uploads',
                    local_backend: true,
                    collections: [{
                      name: 'blog',
                      label: 'Blog Posts',
                      folder: 'content/blog',
                      create: true,
                      slug: '{{slug}}',
                      fields: [
                        {label: 'Title', name: 'title', widget: 'string'},
                        {label: 'Title (Italian)', name: 'titleIT', widget: 'string'},
                        {label: 'Slug', name: 'slug', widget: 'string', pattern: ['^[a-zA-Z0-9-]+$', 'Must be URL friendly']},
                        {label: 'Publish Date', name: 'date', widget: 'datetime'},
                        {label: 'Date (Italian Format)', name: 'dateIT', widget: 'string'},
                        {label: 'Author', name: 'author', widget: 'string', default: 'Luciano Tumminello'},
                        {label: 'Author Image URL', name: 'authorImageUrl', widget: 'string', default: 'https://www.lucianotumminello.com/lovable-uploads/56f210ad-b756-429e-b8fd-f28fbbee4cfc.png'},
                        {label: 'Category', name: 'category', widget: 'string'},
                        {label: 'Category (Italian)', name: 'categoryIT', widget: 'string'},
                        {label: 'Tags', name: 'tags', widget: 'list'},
                        {label: 'Tags (Italian)', name: 'tagsIT', widget: 'list'},
                        {label: 'Reading Time', name: 'readingTime', widget: 'string'},
                        {label: 'Reading Time (Italian)', name: 'readingTimeIT', widget: 'string'},
                        {label: 'Featured Image', name: 'desktopImageUrl', widget: 'image', required: true},
                        {label: 'Mobile Image', name: 'imageUrl', widget: 'image', required: true},
                        {label: 'Excerpt', name: 'excerpt', widget: 'text'},
                        {label: 'Excerpt (Italian)', name: 'excerptIT', widget: 'text'},
                        {label: 'Content', name: 'content', widget: 'markdown'},
                        {label: 'Content (Italian)', name: 'contentIT', widget: 'markdown'},
                        {label: 'Published', name: 'published', widget: 'boolean', default: true}
                      ]
                    }]
                  }
                });
                console.log('CMS initialized successfully');
              } else {
                throw new Error('CMS object not available after script load');
              }
            } catch (error) {
              console.error('CMS initialization error:', error);
              showError('Failed to initialize CMS: ' + error.message);
            }
          }, 1000);
        };
        
        script.onerror = function() {
          console.error('Failed to load CMS script');
          showError('Failed to load CMS script. Please check your internet connection.');
        };
        
        document.head.appendChild(script);
      }

      // Start loading when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadCMS);
      } else {
        loadCMS();
      }

      // Global error handler
      window.addEventListener('error', function(event) {
        console.error('Global error:', event.error);
        if (event.error && event.error.message && event.error.message.includes('removeChild')) {
          showError('CMS initialization error detected. This may be due to conflicting scripts.');
        }
      });
    </script>
  </body>
</html>
